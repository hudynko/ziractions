name: Deploy to mds.insights.zirsee.com Environment

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Target branch to deploy (not possible to be a dropdown sorry)'
        required: true
        default: 'main'
        type: string
      environment_variables_frontend:
        description: 'Environment variables to set frontend with ; for separated key=value pairs'
        required: false
        default: 'VITE_FEATURE_FLAGS='
        type: string
      environment_variables_backend:
        description: 'Environment variables to set backend with ; for separated key=value pairs'
        required: false
        default: ''
        type: string
      skip_cleanup:
        description: 'Skip PostgreSQL cleanup (notskip to enable cleanup)'
        required: false
        default: ''
        type: string
      build_type:
        description: 'Build type: full|backend|frontend (default: full)'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - backend
          - frontend
      quick_deploy:
        description: 'Quick deploy mode: update - skip build/stack removal, just update services'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - update

jobs:
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_branch || 'main' }}

      - name: Set Environment Variables
        run: |
          echo "BRANCH_NAME=${{ github.event.inputs.target_branch || github.ref_name }}" >> $GITHUB_ENV
          echo "SSH_USER=${{ secrets.SSH_USER_FOR_DEPLOY_ZIRSEE }}" >> $GITHUB_ENV
          echo "SSH_HOST=${{ secrets.SSH_HOST_ZIRSEE }}" >> $GITHUB_ENV          
          
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          echo "DEPLOYMENT_LOG_FILE=main_deployment_${TIMESTAMP}.log" >> $GITHUB_ENV
          echo "SSH_CONNECTION_TIMEOUT=10" >> $GITHUB_ENV
          echo "TIMESTAMP=${TIMESTAMP}" >> $GITHUB_ENV

      - name: Setup WireGuard VPN
        run: |
          echo "üì° Installing WireGuard..."
          sudo apt-get update -qq
          sudo apt-get install -y wireguard
          
          echo "üîß Configuring WireGuard..."
          echo "${{ secrets.WIREGUARD_CONFIG_ZIRSEE }}" | sudo tee /etc/wireguard/wg0.conf > /dev/null
          sudo chmod 600 /etc/wireguard/wg0.conf
          
          echo "üöÄ Starting WireGuard connection..."
          sudo wg-quick up wg0
          echo "‚úÖ WireGuard connected successfully!"
        timeout-minutes: 1

      - name: Verify VPN Connection
        run: |
          echo "üîç Verifying WireGuard connection..."
          sudo wg show
          
          echo "üèì Testing connectivity to a known internal IP (e.g., VPN gateway or internal host)..."
          if ping -c 3 10.0.0.2 > /dev/null 2>&1; then
            echo "‚úÖ VPN connectivity test passed."
          else
            echo "‚ùå VPN connectivity test failed. Exiting."
            exit 1
          fi

      - name: Configure SSH Connection
        run: |
          echo "üîê Setting up SSH configuration..."
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          echo "${{ secrets.SSH_PRIVATE_KEY_FOR_DEPLOY_ZIRSEE }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          if ssh-keygen -l -f ~/.ssh/id_rsa > /dev/null 2>&1; then
            echo "‚úÖ SSH key format is valid."
          else
            echo "‚ùå Error: SSH private key format validation failed. Check your secret."
            exit 1
          fi
          
          echo "üîç Adding $SSH_HOST to known_hosts..."
          if ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts 2>/dev/null; then
            echo "‚úÖ Successfully added $SSH_HOST to known_hosts."
          else
            echo "‚ö†Ô∏è Could not add host to known_hosts. Proceeding with StrictHostKeyChecking=no. (Less secure, but common in CI/CD for dynamic hosts)."
          fi

      - name: Test SSH Connection
        timeout-minutes: 1
        run: |
          echo "üîå Testing SSH connection to $SSH_HOST..."
          
          if timeout 30 ssh -i ~/.ssh/id_rsa \
              -o ConnectTimeout=5 \
              -o ServerAliveInterval=2 \
              -o ServerAliveCountMax=3 \
              -o StrictHostKeyChecking=no \
              -o BatchMode=yes \
              "$SSH_USER@$SSH_HOST" "echo 'SSH connection test successful'"; then
            echo "‚úÖ SSH connection test passed."
          else
            echo "‚ùå SSH connection test failed or timed out after 30 seconds."
            exit 1
          fi
      - name: Deploy Application
        run: |
          echo "üöÄ Starting deployment process..."
          echo "üìã Deployment Details:"
          echo "  - Branch: $BRANCH_NAME"
          echo "  - Environment: $ENVIRONMENT"
          echo "  - Target Host: $SSH_HOST"
          echo "  - User: $SSH_USER"
          echo "  - Log File: $DEPLOYMENT_LOG_FILE"
          
          ENV_VARS="${{ github.event.inputs.environment_variables_frontend || '' }}"
          ENV_VARS_BACKEND="${{ github.event.inputs.environment_variables_backend || '' }}"
          SKIP_CLEANUP="${{ github.event.inputs.skip_cleanup || '' }}"
          BUILD_TYPE="${{ github.event.inputs.build_type || 'full' }}"
          QUICK_DEPLOY="${{ github.event.inputs.quick_deploy || 'full' }}"
          echo "  - Frontend Variables: $ENV_VARS"
          echo "  - Backend Variables: $ENV_VARS_BACKEND"
          echo "  - Skip Cleanup: $SKIP_CLEANUP"
          echo "  - Build Type: $BUILD_TYPE"
          echo "  - Quick Deploy: $QUICK_DEPLOY"
          
          # Start actual deployment script
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << EOF
          echo "üìÑ Creating deployment info file..."
          cat > ~/deployment_info_$TIMESTAMP.txt << 'INFOEOF'
          üöÄ GitHub Actions Deployment Report
          =====================================
          Deployed at: \$(date)
          Environment: $ENVIRONMENT
          Branch: $BRANCH_NAME
          Repository: ${{ github.repository }}
          Commit SHA: ${{ github.sha }}
          Triggered by: ${{ github.actor }}
          Workflow: ${{ github.workflow }}
          Timestamp: $TIMESTAMP
          Log File: $DEPLOYMENT_LOG_FILE

          Frontend Environment Variables:
          $ENV_VARS

          Backend Environment Variables:
          $ENV_VARS_BACKEND
          
          Skip Cleanup: $SKIP_CLEANUP
          Build Type: $BUILD_TYPE
          Quick Deploy: $QUICK_DEPLOY
          =====================================
          INFOEOF
          echo "‚úÖ Deployment info file created successfully."
          echo "üìÑ Deployment info file created at ~/deployment_info_$TIMESTAMP.txt"
          
          echo "üîÑ Starting deployment script..."
          if [ -f "/docker/projects/deploy_scripts/reportingoDeployMDS.sh" ]; then
            echo "Environment variables to pass:"
            echo "  Frontend: $ENV_VARS"
            echo "  Backend: $ENV_VARS_BACKEND"
            echo "  Skip Cleanup: $SKIP_CLEANUP"
            echo "  Build Type: $BUILD_TYPE"
            echo "  Quick Deploy: $QUICK_DEPLOY"

            stdbuf -oL -eL bash -l -c "cd /docker/projects/deploy_scripts && ./reportingoDeployMDS.sh '$BRANCH_NAME' '$ENV_VARS' '$ENV_VARS_BACKEND' '$SKIP_CLEANUP' '$BUILD_TYPE' '$QUICK_DEPLOY' 2>&1 | tee /tmp/deploy.log"

            echo "‚úÖ Deployment script completed successfully"
          else
            echo "‚ùå Error: Deployment script not found at /docker/projects/deploy_scripts/reportingoDeployMDS.sh"
            exit 1
          fi
          EOF
      - name: Deployment Summary
        run: |
          echo "üìä Deployment Summary"
          echo "===================="
          echo "‚úÖ Environment: $ENVIRONMENT"
          echo "‚úÖ Branch: $BRANCH_NAME"
          echo "‚úÖ Target Host: $SSH_HOST"
          echo "‚úÖ Deployment script started in background on remote host."
          echo "‚úÖ Remote Log File: ~/$DEPLOYMENT_LOG_FILE"
          echo "‚úÖ Timestamp: $TIMESTAMP"
          echo ""
          echo "üìù To monitor deployment progress on the remote server:"
          echo "   ssh $SSH_USER@$SSH_HOST 'tail -f ~/$DEPLOYMENT_LOG_FILE'"
          echo ""
          echo "üîç To check if the deployment script is still running:"
          echo "   ssh $SSH_USER@$SSH_HOST 'ps aux | grep reportingoDeployMDS.sh'"

      - name: Cleanup VPN Connection
        if: always()
        run: |
          echo "üßπ Cleaning up WireGuard connection..."
          sudo wg-quick down wg0 || true
          echo "‚úÖ WireGuard disconnected successfully."
