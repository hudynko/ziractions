name: Deploy to Staging Environment

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Target branch to deploy (not possible to be a dropdown sorry)'
        required: true
        default: 'main'
        type: string
      environment_variables_frontend:
        description: 'Environment variables to set frontend with ; for separated key=value pairs'
        required: false
        default: 'VITE_FEATURE_FLAGS='
        type: string
      environment_variables_backend:
        description: 'Environment variables to set backend with ; for separated key=value pairs'
        required: false
        default: ''
        type: string
      skip_cleanup:
        description: 'Skip PostgreSQL cleanup (notskip to enable cleanup)'
        required: false
        default: ''
        type: string
      build_type:
        description: 'Build type: full|backend|frontend (default: full)'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - backend
          - frontend
      quick_deploy:
        description: 'Quick deploy mode: update - skip build/stack removal, just update services'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - update

jobs:
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Environment Variables
        run: |
          echo "ENVIRONMENT=staging" >> $GITHUB_ENV
          echo "BRANCH_NAME=${{ github.event.inputs.target_branch }}" >> $GITHUB_ENV
          echo "BUILD_TYPE=${{ github.event.inputs.build_type }}" >> $GITHUB_ENV
          echo "QUICK_DEPLOY=${{ github.event.inputs.quick_deploy }}" >> $GITHUB_ENV
          echo "ENV_VARS=${{ github.event.inputs.environment_variables_frontend }}" >> $GITHUB_ENV
          echo "ENV_VARS_BACKEND=${{ github.event.inputs.environment_variables_backend }}" >> $GITHUB_ENV
          echo "SKIP_CLEANUP=${{ github.event.inputs.skip_cleanup }}" >> $GITHUB_ENV
          echo "SSH_HOST=${{ secrets.SSH_HOST }}" >> $GITHUB_ENV
          echo "SSH_USER=${{ secrets.SSH_USER }}" >> $GITHUB_ENV
          echo "TIMESTAMP=$(date +%Y%m%d_%H%M%S)" >> $GITHUB_ENV
          echo "DEPLOYMENT_LOG_FILE=staging_deployment_$(date +%Y%m%d_%H%M%S).log" >> $GITHUB_ENV

      - name: Install WireGuard
        run: |
          echo "ğŸ”§ Installing WireGuard..."
          sudo apt-get update
          sudo apt-get install -y wireguard
          echo "âœ… WireGuard installed successfully."

      - name: Setup WireGuard Configuration
        run: |
          echo "ğŸ”§ Setting up WireGuard configuration..."
          echo "${{ secrets.WIREGUARD_CONFIG }}" | sudo tee /etc/wireguard/wg0.conf > /dev/null
          sudo chmod 600 /etc/wireguard/wg0.conf
          echo "âœ… WireGuard configuration created."

      - name: Connect to WireGuard
        run: |
          echo "ğŸ”— Connecting to WireGuard VPN..."
          sudo wg-quick up wg0
          echo "âœ… WireGuard connected successfully."
          
          echo "ğŸ” Verifying connection..."
          sudo wg show
          
          echo "ğŸŒ Testing connectivity..."
          ping -c 3 $SSH_HOST || echo "âš ï¸ Ping test failed, but proceeding with deployment..."

      - name: Setup SSH
        run: |
          echo "ğŸ”§ Setting up SSH configuration..."
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Add host to known_hosts to avoid interactive prompts
          ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts
          
          echo "âœ… SSH configured successfully."

      - name: Test SSH Connection
        run: |
          echo "ğŸ” Testing SSH connection to $SSH_HOST..."
          ssh -o ConnectTimeout=10 $SSH_USER@$SSH_HOST "echo 'SSH connection successful! Server time:'; date"
          echo "âœ… SSH connection verified."

      - name: Deploy Application
        run: |
          echo "ğŸš€ Starting Staging Environment Deployment"
          echo "=========================================="
          echo "ğŸ¯ Environment: $ENVIRONMENT"
          echo "ğŸŒ¿ Branch: $BRANCH_NAME"
          echo "ğŸ–¥ï¸  Target Host: $SSH_HOST"
          echo "ğŸ“ Build Type: $BUILD_TYPE"
          echo "âš¡ Quick Deploy: $QUICK_DEPLOY"
          echo "ğŸ”§ Frontend Env Vars: $ENV_VARS"
          echo "ğŸ”§ Backend Env Vars: $ENV_VARS_BACKEND"
          echo "ğŸ§¹ Skip Cleanup: $SKIP_CLEANUP"
          echo "ğŸ“… Timestamp: $TIMESTAMP"
          echo ""

          # Run deployment on remote host
          ssh $SSH_USER@$SSH_HOST << 'EOF'
          set -e
          
          # Create deployment info file
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          cat > ~/deployment_info_$TIMESTAMP.txt << INFOEOF
          ==========================================
          ğŸš€ Staging Environment Deployment Info
          ==========================================
          ğŸ“… Deployment Time: $(date)
          ğŸ¯ Environment: staging
          ğŸŒ¿ Branch/Tag: $BRANCH_NAME
          ğŸ“ Build Type: $BUILD_TYPE
          âš¡ Quick Deploy Mode: $QUICK_DEPLOY
          ğŸ”§ Frontend Environment Variables: $ENV_VARS
          ğŸ”§ Backend Environment Variables: $ENV_VARS_BACKEND
          ğŸ§¹ Skip Cleanup: $SKIP_CLEANUP
          ğŸ–¥ï¸  Target Host: $SSH_HOST
          ğŸ‘¤ Deployed By: GitHub Actions
          ğŸ“‹ Workflow: zirsee-staging-deploy.yml
          ==========================================
          INFOEOF
          echo "âœ… Deployment info file created successfully."
          echo "ğŸ“„ Deployment info file created at ~/deployment_info_$TIMESTAMP.txt"
          
          echo "ğŸ”„ Starting deployment script..."
          if [ -f "/docker/projects/deploy_scripts/reportingodeploystaging.sh" ]; then
            echo "Parameters to pass:"
            echo "  Branch: $BRANCH_NAME"
            echo "  Frontend Env Vars: $ENV_VARS"
            echo "  Backend Env Vars: $ENV_VARS_BACKEND"
            echo "  Skip Cleanup: $SKIP_CLEANUP"
            echo "  Build Type: $BUILD_TYPE"
            echo "  Quick Deploy: $QUICK_DEPLOY"

            stdbuf -oL -eL bash -l -c "cd /docker/projects/deploy_scripts && ./reportingodeploystaging.sh '$BRANCH_NAME' '$ENV_VARS' '$ENV_VARS_BACKEND' '$SKIP_CLEANUP' '$BUILD_TYPE' '$QUICK_DEPLOY' 2>&1 | tee /tmp/deploy.log"

            echo "âœ… Deployment script completed successfully"
          else
            echo "âŒ Error: Deployment script not found at /docker/projects/deploy_scripts/reportingodeploystaging.sh"
            exit 1
          fi
          EOF

      - name: Deployment Summary
        run: |
          echo "ğŸ“Š Deployment Summary"
          echo "===================="
          echo "âœ… Environment: $ENVIRONMENT"
          echo "âœ… Branch: $BRANCH_NAME"
          echo "âœ… Target Host: $SSH_HOST"
          echo "âœ… Quick Deploy: $QUICK_DEPLOY"
          echo "âœ… Deployment script started in background on remote host."
          echo "âœ… Remote Log File: ~/$DEPLOYMENT_LOG_FILE"
          echo "âœ… Timestamp: $TIMESTAMP"
          echo ""
          echo "ğŸ“ To monitor deployment progress on the remote server:"
          echo "   ssh $SSH_USER@$SSH_HOST 'tail -f ~/$DEPLOYMENT_LOG_FILE'"
          echo ""
          echo "ğŸ” To check if the deployment script is still running:"
          echo "   ssh $SSH_USER@$SSH_HOST 'ps aux | grep reportingodeploystaging.sh'"

      - name: Cleanup VPN Connection
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up WireGuard connection..."
          sudo wg-quick down wg0 || true
          echo "âœ… WireGuard disconnected successfully."