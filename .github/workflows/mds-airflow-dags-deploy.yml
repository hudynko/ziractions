name: Deploy MDS Airflow DAGs

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'dags/**'

jobs:
  deploy:
    name: Deploy MDS DAGs
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Environment Variables
        run: |
          echo "ENVIRONMENT=mds-airflow" >> $GITHUB_ENV
          echo "SSH_HOST=${{ secrets.SSH_HOST }}" >> $GITHUB_ENV
          echo "SSH_USER=${{ secrets.SSH_USER }}" >> $GITHUB_ENV
          echo "TIMESTAMP=$(date +%Y%m%d_%H%M%S)" >> $GITHUB_ENV
          echo "DEPLOYMENT_LOG_FILE=mds_dags_deployment_$(date +%Y%m%d_%H%M%S).log" >> $GITHUB_ENV

      - name: Install WireGuard
        run: |
          echo "üîß Installing WireGuard..."
          sudo apt-get update
          sudo apt-get install -y wireguard
          echo "‚úÖ WireGuard installed successfully."

      - name: Setup WireGuard Configuration
        run: |
          echo "üîß Setting up WireGuard configuration..."
          echo "${{ secrets.WIREGUARD_CONFIG }}" | sudo tee /etc/wireguard/wg0.conf > /dev/null
          sudo chmod 600 /etc/wireguard/wg0.conf
          echo "‚úÖ WireGuard configuration created."

      - name: Connect to WireGuard
        run: |
          echo "üîó Connecting to WireGuard VPN..."
          sudo wg-quick up wg0
          echo "‚úÖ WireGuard connected successfully."
          
          echo "üîç Verifying connection..."
          sudo wg show
          
          echo "üåê Testing connectivity..."
          ping -c 3 $SSH_HOST || echo "‚ö†Ô∏è Ping test failed, but proceeding with deployment..."

      - name: Setup SSH
        run: |
          echo "üîß Setting up SSH configuration..."
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Add host to known_hosts to avoid interactive prompts
          ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts
          
          echo "‚úÖ SSH configured successfully."

      - name: Test SSH Connection
        run: |
          echo "üîç Testing SSH connection to $SSH_HOST..."
          ssh -o ConnectTimeout=10 $SSH_USER@$SSH_HOST "echo 'SSH connection successful! Server time:'; date"
          echo "‚úÖ SSH connection verified."

      - name: Deploy MDS Airflow DAGs
        run: |
          echo "üöÄ Starting MDS Airflow DAGs Deployment"
          echo "======================================="
          echo "üéØ Environment: $ENVIRONMENT"
          echo "üñ•Ô∏è  Target Host: $SSH_HOST"
          echo "üìÖ Timestamp: $TIMESTAMP"
          echo ""

          # Run deployment on remote host
          ssh $SSH_USER@$SSH_HOST << 'EOF'
          set -e
          
          # Create deployment info file
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          cat > ~/deployment_info_$TIMESTAMP.txt << INFOEOF
          ======================================
          üöÄ MDS Airflow DAGs Deployment Info
          ======================================
          üìÖ Deployment Time: $(date)
          üéØ Environment: MDS Airflow Production
          üñ•Ô∏è  Target Host: $SSH_HOST
          üë§ Deployed By: GitHub Actions
          üìã Workflow: mds-airflow-dags-deploy.yml
          üìÇ Target: /docker/airflow-mds-production/dags/
          ======================================
          INFOEOF
          echo "‚úÖ Deployment info file created successfully."
          echo "üìÑ Deployment info file created at ~/deployment_info_$TIMESTAMP.txt"
          
          echo "üîÑ Starting DAGs deployment script..."
          if [ -f "/docker/projects/deploy_scripts/pullAndCopyMdsDags.sh" ]; then
            echo "üöÄ Executing MDS DAGs deployment..."

            stdbuf -oL -eL bash -l -c "cd /docker/projects/deploy_scripts && ./pullAndCopyMdsDags.sh 2>&1 | tee /tmp/mds_dags_deploy.log"

            echo "‚úÖ MDS DAGs deployment completed successfully"
          else
            echo "‚ùå Error: Deployment script not found at /docker/projects/deploy_scripts/pullAndCopyMdsDags.sh"
            exit 1
          fi
          EOF

      - name: Deployment Summary
        run: |
          echo "üìä Deployment Summary"
          echo "===================="
          echo "‚úÖ Environment: $ENVIRONMENT"
          echo "‚úÖ Target Host: $SSH_HOST"
          echo "‚úÖ MDS Airflow DAGs deployment completed."
          echo "‚úÖ Remote Log File: ~/$DEPLOYMENT_LOG_FILE"
          echo "‚úÖ Timestamp: $TIMESTAMP"
          echo ""
          echo "üìù To monitor deployment logs on the remote server:"
          echo "   ssh $SSH_USER@$SSH_HOST 'tail -f /tmp/mds_dags_deploy.log'"
          echo ""
          echo "üîç To check DAGs status:"
          echo "   ssh $SSH_USER@$SSH_HOST 'ls -la /docker/airflow-mds-production/dags/'"

      - name: Cleanup VPN Connection
        if: always()
        run: |
          echo "üßπ Cleaning up WireGuard connection..."
          sudo wg-quick down wg0 || true
          echo "‚úÖ WireGuard disconnected successfully."